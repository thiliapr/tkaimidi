# MIDI 处理与线程工具库 · API 文档

---

## `ThreadVariable[T]`

线程安全的变量封装类。

| 参数名     | 类型  | 描述        |
| ------- | --- | --------- |
| `value` | `T` | 初始值，泛型类型。 |

---

## `BufferStream[T]`

线程安全的缓冲流迭代器，支持多线程生产与消费。

### 方法：`send(data)`

| 参数名    | 类型        | 描述            |
| ------ | --------- | ------------- |
| `data` | `list[T]` | 要添加到缓冲区的数据列表。 |

### 方法：`stop()`

无参数，用于安全停止迭代器。

---

## `midi_to_notes(midi_file) -> list[tuple[int, int]]`

提取 MIDI 文件中的音符信息及其时间间隔。

| 参数名         | 类型              | 描述              |
| ----------- | --------------- | --------------- |
| `midi_file` | `mido.MidiFile` | 要解析的 MIDI 文件对象。 |

| 返回值 | 类型                      | 描述               |
| --- | ----------------------- | ---------------- |
| -   | `list[tuple[int, int]]` | 每个元组包含音高和相对时间间隔。 |

---

## `notes_to_sheet(notes, lookahead_count=DEFAULT_LOOKAHEAD_COUNT) -> tuple[list[int], list[int]]`

将音符信息转换为电子乐谱。

| 参数名               | 类型                      | 描述                                                 |
| ----------------- | ----------------------- | -------------------------------------------------- |
| `notes`           | `list[tuple[int, int]]` | 音高和相对时间的音符列表。                                      |
| `lookahead_count` | `int`                   | 向前查看的音符数量，用于偏移判断。默认值为常量 `DEFAULT_LOOKAHEAD_COUNT`。 |

| 返回值         | 类型          | 描述             |
| ----------- | ----------- | -------------- |
| `sheet`     | `list[int]` | 电子乐谱事件列表。      |
| `positions` | `list[int]` | 每个音符在乐谱中的位置索引。 |

---

## `sheet_to_notes(sheet) -> Iterator[tuple[int, int, int]]`

将电子乐谱转换为音符流。

| 参数名     | 类型              | 描述                                |
| ------- | --------------- | --------------------------------- |
| `sheet` | `Iterator[int]` | 电子乐谱数据流（由 `notes_to_sheet()` 生成）。 |

| 返回值 | 类型                               | 描述                         |
| --- | -------------------------------- | -------------------------- |
| -   | `Iterator[tuple[int, int, int]]` | `(音高, 时间间隔, 当前全局偏移)` 的生成器。 |

---

## `empty_cache()`

清理 CUDA 显存并进行垃圾回收。

| 参数名   | 类型    | 描述                              |
| ----- | ----- | ------------------------------- |
| *(无)* | *(无)* | 自动检测并清空 CUDA 缓存，执行 Python 垃圾回收。 |
